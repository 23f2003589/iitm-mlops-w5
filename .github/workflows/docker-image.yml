name: Build, Deploy and AutoScale Test with wrk

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  PROJECT_ID: nifty-harmony-474217-q6
  GAR_LOCATION: us-central1
  GAR_REPOSITORY: my-repo
  GKE_CLUSTER: iris-cluster
  GKE_LOCATION: us-central1
  DEPLOYMENT_NAME: iris-api
  IMAGE_NAME: iris-api

jobs:
  build-deploy-autoscale:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker "${{ env.GAR_LOCATION }}-docker.pkg.dev"

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_LOCATION }}

      - name: Deploy to GKE with Autoscaling
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl set image deployment/${DEPLOYMENT_NAME} ${DEPLOYMENT_NAME}=${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPOSITORY}/${IMAGE_NAME}:${GITHUB_SHA}
          kubectl rollout status deployment/${DEPLOYMENT_NAME}

          # Enable autoscaling: min=1, max=3 pods, target 80% CPU
          kubectl autoscale deployment ${DEPLOYMENT_NAME} --min=1 --max=3 --cpu-percent=80
          kubectl get hpa

      - name: Install wrk and Run Stress Test (Autoscaling)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev git jq
          git clone https://github.com/wg/wrk.git /tmp/wrk
          cd /tmp/wrk && make && sudo cp wrk /usr/local/bin/ && cd -

          echo 'wrk.method="POST"' > test.lua
          echo 'wrk.body=[[{"sepal_length":5.1,"sepal_width":3.5,"petal_length":1.4,"petal_width":0.2}]]' >> test.lua
          echo 'wrk.headers["Content-Type"]="application/json"' >> test.lua

          echo "Waiting for external IP..."
          for i in {1..30}; do
            IP=$(kubectl get svc ${DEPLOYMENT_NAME}-service -o json | jq -r '.status.loadBalancer.ingress[0].ip // empty')
            [[ -n "$IP" ]] && break
            echo "Retrying... ($i)"
            sleep 10
          done
          echo "External IP: $IP"

          wrk -t4 -c1000 -d30s --latency -s test.lua "http://${IP}:80/predict" | tee wrk_autoscale_results.txt

      - name: Upload wrk Results
        uses: actions/upload-artifact@v4
        with:
          name: wrk-autoscale-results
          path: wrk_autoscale_results.txt
