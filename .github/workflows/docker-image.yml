name: Demonstrate Kubernetes Autoscaling (max 3 pods)

on:
  workflow_dispatch:

env:
  PROJECT_ID: nifty-harmony-474217-q6
  GAR_LOCATION: us-central1
  GAR_REPOSITORY: my-repo
  GKE_CLUSTER: iris-cluster
  GKE_LOCATION: us-central1
  DEPLOYMENT_NAME: iris-api
  IMAGE_NAME: iris-api

jobs:
  autoscale-test:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
      
      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_LOCATION }}
      
      - name: Configure autoscaler (min 1, max 3 pods)
        run: |
          kubectl scale deployment/${DEPLOYMENT_NAME} --replicas=1
          kubectl autoscale deployment ${DEPLOYMENT_NAME} --min=1 --max=3 --cpu-percent=50
          kubectl get hpa ${DEPLOYMENT_NAME}
      
      - name: Wait for Service External IP
        run: |
          echo "Waiting for external IP..."
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get svc ${DEPLOYMENT_NAME}-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [[ -n "$EXTERNAL_IP" ]]; then
              echo "Found IP: $EXTERNAL_IP"
              echo "EXTERNAL_IP=$EXTERNAL_IP" >> $GITHUB_ENV
              break
            fi
            sleep 10
          done
          if [[ -z "$EXTERNAL_IP" ]]; then
            echo "No IP found!"
            exit 1
          fi
      
      - name: Install wrk
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev git jq
          git clone https://github.com/wg/wrk.git
          cd wrk && make && sudo cp wrk /usr/local/bin && cd ..
      
      - name: Create wrk test script
        run: |
          cat > test.lua <<'EOF'
          wrk.method = "POST"
          wrk.body = '{"sepal_length":5.1,"sepal_width":3.5,"petal_length":1.4,"petal_width":0.2}'
          wrk.headers["Content-Type"] = "application/json"
          EOF
      
      - name: Run wrk test (1000 concurrent connections)
        run: |
          wrk -t8 -c1000 -d30s --latency -s test.lua "http://${EXTERNAL_IP}:80/predict" | tee wrk_autoscale.txt
          kubectl get hpa
          kubectl get pods -o wide
      
      - name: Upload wrk results
        uses: actions/upload-artifact@v4
        with:
          name: wrk-autoscaling-results
          path: wrk_autoscale.txt
